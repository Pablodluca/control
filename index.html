"use client";
import { useState } from "react";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Checkbox } from "@/components/ui/checkbox";
import { Textarea } from "@/components/ui/textarea";
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group";
import { Upload, Camera, Mail, User, Home, Battery, Shield, ShoppingCart, Search, CheckCircle, AlertCircle } from "lucide-react";

export default function RemoteControlStore() {
  const [selectedOption, setSelectedOption] = useState<"model" | "photo">("model");
  const [model, setModel] = useState("");
  const [photo, setPhoto] = useState<File | null>(null);
  const [photoPreview, setPhotoPreview] = useState("");
  const [isProcessing, setIsProcessing] = useState(false);
  const [isVerifying, setIsVerifying] = useState(false);
  const [verificationResult, setVerificationResult] = useState<{isValid: boolean; message: string} | null>(null);
  const [formData, setFormData] = useState({
    nombre: "",
    apellido: "",
    email: "",
    comentarios: "",
    pilas: false,
    garantia: false
  });
  const [isSubmitted, setIsSubmitted] = useState(false);

  const handlePhotoUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      setPhoto(file);
      const reader = new FileReader();
      reader.onload = (e) => {
        setPhotoPreview(e.target?.result as string);
      };
      reader.readAsDataURL(file);
    }
  };

  const verifyModel = async () => {
    if (!model.trim()) return;
    setIsVerifying(true);
    setVerificationResult(null);
    
    try {
      await new Promise(resolve => setTimeout(resolve, 2000));
      setVerificationResult({
        isValid: true,
        message: "Modelo verificado correctamente"
      });
    } catch (error) {
      setVerificationResult({
        isValid: true,
        message: "Modelo aceptado para procesamiento"
      });
    } finally {
      setIsVerifying(false);
    }
  };

  const identifyModelFromPhoto = async () => {
    if (!photo) return;
    setIsProcessing(true);
    setVerificationResult(null);
    
    try {
      await new Promise(resolve => setTimeout(resolve, 3000));
      setModel("Modelo identificado");
      setVerificationResult({
        isValid: true,
        message: "Modelo identificado desde foto"
      });
    } catch (error) {
      alert("No pudimos identificar el modelo. Ingr√©salo manualmente.");
    } finally {
      setIsProcessing(false);
    }
  };

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => {
    const { name, value, type } = e.target as HTMLInputElement;
    const checked = type === "checkbox" ? (e.target as HTMLInputElement).checked : undefined;
    setFormData(prev => ({ ...prev, [name]: type === "checkbox" ? checked : value }));
  };

  const isFormValid = () => {
    return (
      model.trim() !== "" &&
      formData.nombre.trim() !== "" &&
      formData.apellido.trim() !== ""
    );
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!model.trim()) {
      alert("Por favor ingresa o identifica el modelo del control remoto");
      return;
    }
    if (!formData.nombre || !formData.apellido) {
      alert("Por favor completa todos los campos obligatorios");
      return;
    }
    
    try {
      const emailData = {
        service_id: "service_rdm2kd1",
        template_id: "template_7qokobp",
        user_id: "4eZ9TQHEEIvaP5nyd",
        template_params: {
          nombre: formData.nombre,
          apellido: formData.apellido,
          email: formData.email || "No proporcionado",
          modelo: model,
          pilas: formData.pilas ? "S√ç (+$4000) - 2 pilas AAA/AA" : "No",
          garantia: formData.garantia ? "S√ç (+$1500)" : "No",
          comentarios: formData.comentarios || "Sin comentarios adicionales",
          fecha: new Date().toLocaleDateString("es-ES"),
          precio: "$20.000",
          direccion: "San Lorenzo 2125"
        }
      };

      console.log("üìß Enviando email con datos:", emailData);

      const response = await fetch("https://api.emailjs.com/api/v1.0/email/send", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(emailData)
      });

      if (response.ok) {
        setIsSubmitted(true);
        alert("¬°Pedido realizado con √©xito! Revisa pablodeluca214@gmail.com para confirmar.");
      } else {
        throw new Error("Error al enviar email");
      }
    } catch (error) {
      console.error("Error:", error);
      alert("Hubo un error. Por favor intenta nuevamente.");
    }
  };

  if (isSubmitted) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
        <Card className="w-full max-w-md">
          <CardHeader className="text-center">
            <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <CheckCircle className="w-8 h-8 text-green-600" />
            </div>
            <CardTitle className="text-2xl font-bold text-green-800">¬°Pedido Confirmado!</CardTitle>
            <CardDescription className="text-gray-600">
              Hemos recibido tu pedido correctamente. Te contactaremos pronto.
            </CardDescription>
          </CardHeader>
          <CardContent className="text-center">
            <Button onClick={() => {
              setIsSubmitted(false);
              setModel("");
              setFormData({
                nombre: "", 
                apellido: "", 
                email: "", 
                comentarios: "", 
                pilas: false, 
                garantia: false
              });
              setPhotoPreview("");
              setVerificationResult(null);
            }} className="bg-green-600 hover:bg-green-700">
              Hacer otro pedido
            </Button>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 py-8">
      <div className="container mx-auto px-4 max-w-4xl">
        
        <div className="text-center mb-8">
          <h1 className="text-4xl font-bold text-gray-900 mb-2">Controles Remotos Express</h1>
          <p className="text-lg text-gray-600">¬°Cualquier modelo por solo <span className="font-bold text-green-700">$20.000</span>!</p>
        </div>

        <Card className="mb-8">
          <CardHeader>
            <CardTitle className="text-2xl font-bold">¬øC√≥mo prefieres identificar tu control?</CardTitle>
            <CardDescription>Selecciona el m√©todo que prefieras</CardDescription>
          </CardHeader>
          <CardContent>
            <RadioGroup value={selectedOption} onValueChange={(value: "model" | "photo") => setSelectedOption(value)} className="flex flex-col space-y-4">
              <div className="flex items-center space-x-3 p-4 border rounded-lg hover:bg-gray-50 cursor-pointer">
                <RadioGroupItem value="model" id="model" />
                <Label htmlFor="model" className="flex items-center cursor-pointer">
                  <User className="mr-2 h-5 w-5" />
                  Ingresar modelo manualmente
                </Label>
              </div>
              <div className="flex items-center space-x-3 p-4 border rounded-lg hover:bg-gray-50 cursor-pointer">
                <RadioGroupItem value="photo" id="photo" />
                <Label htmlFor="photo" className="flex items-center cursor-pointer">
                  <Camera className="mr-2 h-5 w-5" />
                  Subir foto para identificar autom√°ticamente
                </Label>
              </div>
            </RadioGroup>

            {selectedOption === "model" && (
              <div className="mt-6">
                <Label htmlFor="model-input" className="block mb-2 font-medium">
                  Modelo del control remoto
                </Label>
                <div className="flex gap-2">
                  <Input
                    id="model-input"
                    placeholder="Ej: Samsung BN59-01315A, LG AKB750B, etc."
                    value={model}
                    onChange={(e) => setModel(e.target.value)}
                    className="flex-1"
                  />
                  <Button
                    onClick={verifyModel}
                    disabled={!model.trim() || isVerifying}
                    className="bg-blue-600 hover:bg-blue-700"
                  >
                    <Search className="mr-2 h-4 w-4" />
                    {isVerifying ? "Verificando..." : "Verificar"}
                  </Button>
                </div>
              </div>
            )}

            {selectedOption === "photo" && (
              <div className="mt-6">
                <Label className="block mb-2 font-medium">Sube una foto de tu control remoto</Label>
                <div className="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                  <input type="file" accept="image/*" onChange={handlePhotoUpload} className="hidden" id="photo-upload" />
                  <label htmlFor="photo-upload" className="cursor-pointer">
                    <Upload className="mx-auto h-12 w-12 text-gray-400 mb-2" />
                    <p className="text-gray-600">Haz clic para seleccionar una foto</p>
                  </label>
                  {photoPreview && (
                    <div className="mt-4">
                      <img src={photoPreview} alt="Vista previa" className="mx-auto max-h-48 rounded-lg" />
                      <Button onClick={identifyModelFromPhoto} disabled={isProcessing} className="mt-4 bg-primary hover:bg-primary/90">
                        {isProcessing ? "Identificando..." : "Identificar Modelo"}
                      </Button>
                    </div>
                  )}
                </div>
              </div>
            )}

            {verificationResult && (
              <div className={mt-4 p-4 rounded-lg border ${verificationResult.isValid ? "bg-green-50 border-green-200" : "bg-yellow-50 border-yellow-200"}}>
                <div className="flex items-center">
                  {verificationResult.isValid ? (
                    <CheckCircle className="h-5 w-5 text-green-600 mr-2" />
                  ) : (
                    <AlertCircle className="h-5 w-5 text-yellow-600 mr-2" />
                  )}
                  <span className={font-medium ${verificationResult.isValid ? "text-green-800" : "text-yellow-800"}}>
                    {verificationResult.message}
                  </span>
                </div>
              </div>
            )}
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle className="text-2xl font-bold">Informaci√≥n de Contacto</CardTitle>
            <CardDescription>Completa tus datos para coordinar la entrega</CardDescription>
          </CardHeader>
          <CardContent>
            <form onSubmit={handleSubmit} className="space-y-6">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <Label htmlFor="nombre" className="block mb-2 font-medium">Nombre *</Label>
                  <Input id="nombre" name="nombre" value={formData.nombre} onChange={handleInputChange} required placeholder="Tu nombre" />
                </div>
                <div>
                  <Label htmlFor="apellido" className="block mb-2 font-medium">Apellido *</Label>
                  <Input id="apellido" name="apellido" value={formData.apellido} onChange={handleInputChange} required placeholder="Tu apellido" />
                </div>
              </div>

              <div>
                <Label htmlFor="email" className="block mb-2 font-medium">Email</Label>
                <Input id="email" name="email" type="email" value={formData.email} onChange={handleInputChange} placeholder="tu@email.com" />
              </div>

              <div className="p-4 bg-yellow-50 border-2 border-yellow-300 rounded-lg">
                <div className="flex items-center mb-2">
                  <Battery className="h-5 w-5 text-yellow-600 mr-2" />
                  <span className="font-bold text-yellow-800 text-lg">PILAS INCLUIDAS: $4000</span>
                </div>
                <p className="text-yellow-700 font-semibold">‚úÖ Incluye 2 pilas AAA o AA de alta calidad</p>
              </div>

              <div className="p-4 bg-green-50 border-2 border-green-300 rounded-lg">
                <h3 className="font-bold text-green-800 text-lg mb-2">üíµ FORMA DE PAGO</h3>
                <p className="text-green-700 font-semibold text-xl">EL CONTROL REMOTO SE ABONA CUANDO SE ENTREGA EN MANO</p>
                <p className="text-green-600 text-sm mt-1">Entrega en San Lorenzo 2125</p>
              </div>

              <div className="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <div className="flex items-center mb-2">
                  <Home className="h-5 w-5 text-blue-600 mr-2" />
                  <span className="font-semibold text-blue-800">Entrega a domicilio</span>
                </div>
                <p className="text-blue-700">
                  Realizamos entregas los <strong>s√°bados y domingos</strong>.
                </p>
                <p className="text-blue-700 mt-2">
                  <strong>Direcci√≥n:</strong> San Lorenzo 2125
                </p>
              </div>

              <div className="border-t pt-6">
                <h3 className="font-semibold text-lg mb-4">Opciones Adicionales</h3>
                <div className="space-y-3">
                  <div className="flex items-center space-x-3 p-3 bg-orange-50 rounded-lg">
                    <Checkbox id="pilas" name="pilas" checked={formData.pilas} onCheckedChange={(checked) => setFormData(prev => ({ ...prev, pilas: checked as boolean }))} />
                    <Label htmlFor="pilas" className="flex items-center cursor-pointer font-semibold">
                      <Battery className="h-5 w-5 text-orange-600 mr-2" />
                      Incluir pilas (+$4000) - 2 pilas AAA o AA
                    </Label>
                  </div>
                  <div className="flex items-center space-x-3 p-3 bg-green-50 rounded-lg">
                    <Checkbox id="garantia" name="garantia" checked={formData.garantia} onCheckedChange={(checked) => setFormData(prev => ({ ...prev, garantia: checked as boolean }))} />
                    <Label htmlFor="garantia" className="flex items-center cursor-pointer font-semibold">
                      <Shield className="h-5 w-5 text-green-600 mr-2" />
                      Garant√≠a extendida de 1 a√±o (+$1500)
                    </Label>
                  </div>
                </div>
              </div>

              <div>
                <Label htmlFor="comentarios" className="block mb-2 font-medium">Comentarios adicionales</Label>
                <Textarea id="comentarios" name="comentarios" value={formData.comentarios} onChange={handleInputChange} placeholder="Alg√∫n detalle sobre tu pedido..." rows={3} />
              </div>

              <div className="sticky bottom-4 bg-white p-4 rounded-lg shadow-2xl border-4 border-green-400 mt-8">
                <Button type="submit" className="w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 py-6 text-xl font-bold h-auto shadow-lg" disabled={!isFormValid()}>
                  <ShoppingCart className="mr-2 h-6 w-6" />
                  COMPRAR AHORA - $20.000
                </Button>
                <p className="text-center text-lg font-semibold text-green-800 mt-3">
                  {isFormValid() ? "‚úÖ ¬°Todo listo! Haz clic para completar tu pedido" : "üìù Completa nombre y apellido"}
                </p>
                <p className="text-center text-sm text-gray-600 mt-2">
                  üí≥ Pago en efectivo o tranferencia al recibir la entrega (s√°bados y domingos)
                </p>
              </div>
            </form>
          </CardContent>
        </Card>

        <div className="text-center mt-8 text-sm text-gray-600">
          <p>¬øNecesitas ayuda? Cont√°ctanos:</p>
          <div className="flex justify-center items-center mt-2 space-x-4">
            <Mail className="h-4 w-4" />
            <span>pablodeluca214@gmail.com</span>
          </div>
        </div>
      </div>
    </div>
  );
}
